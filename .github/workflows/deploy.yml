name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ (ìƒëµ)
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Java 21 ì„¤ì • (ìƒëµ)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3ï¸âƒ£ Gradle ê¶Œí•œ ì„¤ì • (ìƒëµ)
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4ï¸âƒ£ ë¹Œë“œ JAR (ìƒëµ)
      - name: Build JAR
        run: ./gradlew clean build -x test

      # 5ï¸âƒ£ SSH í‚¤ ì¤€ë¹„ (ìƒëµ)
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo '${{ secrets.EC2_KEY_SERVER2 }}' > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true


      # 5.5ï¸âƒ£ .env íŒŒì¼ì„ Secretì—ì„œ ìƒì„± (âœ¨ìˆ˜ì •ëœ ìŠ¤í…âœ¨)
      # tee ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚´ìš© ì•ë’¤ì— ë¶ˆí•„ìš”í•œ ê³µë°±/ë”°ì˜´í‘œê°€ ë“¤ì–´ê°€ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
      - name: Create .env file
        run: |
          cat <<EOF > .env
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
          MYSQL_USER=${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          EOF
      

      # 6ï¸âƒ£ í”„ë¡œì íŠ¸ íŒŒì¼ë“¤ì„ EC2ë¡œ ë°°í¬ (ìƒëµ)
      - name: Deploy files to EC2
        run: |
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "mkdir -p /home/ubuntu/nginx-app"
          scp -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no build/libs/*.jar ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/nginx-app/
          scp -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no Dockerfile ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/nginx-app/
          scp -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no docker-compose.yml ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/nginx-app/
          scp -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no .env ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/nginx-app/

      # 7ï¸âƒ£ Docker Composeë¡œ ì¬ë°°í¬ (âœ¨ìˆ˜ì •ëœ ìŠ¤í…âœ¨)
      - name: Deploy with Docker Compose
        run: |
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "
            cd /home/ubuntu/nginx-app
          
            # ğŸ’¡ ë””ë²„ê¹…: EC2 ì„œë²„ì— ë³µì‚¬ëœ .env íŒŒì¼ ë‚´ìš© í™•ì¸
            echo '--- DEBUG: Displaying .env content on EC2 ---'
            cat .env
            echo '--- END DEBUG ---'
          
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
            docker compose down
          
            # ì´ë¯¸ì§€ ë¹Œë“œ
            docker build -t nginx-app .
          
            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            docker compose up -d
          
            # í—¬ìŠ¤ ì²´í¬
            echo 'Waiting for application to start...'
            sleep 15
          
            if docker ps | grep -q 'kjmate-backend.*Up'; then
              echo 'Deployment successful! Application is running.'
              docker ps
            else
              echo 'Deployment failed! Container is not running.'
              docker logs kjmate-backend
              exit 1
            fi
          "

      # 8ï¸âƒ£ ì •ë¦¬ (ìƒëµ)
      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/ec2_key.pem